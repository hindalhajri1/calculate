<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Talab</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#5b2ea6;
      --brand2:#7a43d1;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 24px rgba(17,24,39,.06);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    .container{
      max-width:1150px;
      margin:22px auto 40px;
      padding:0 16px;
    }

    /* Top header (Google Forms vibe) */
    .top{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-radius:22px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .top .who{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:220px;
    }
    .top .who .hello{
      font-size:20px;
      font-weight:900;
      margin:0;
      line-height:1.2;
    }
    .top .who .time{
      font-size:12.5px;
      color:rgba(255,255,255,.85);
      font-weight:700;
    }
    .top .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      border:0;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:13.5px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      user-select:none;
    }
    .btn.white{background:#fff;color:var(--brand)}
    .btn.soft{background:rgba(255,255,255,.18);color:#fff}
    .btn:active{transform:translateY(1px)}
    .btn svg{width:16px;height:16px}

    /* Section */
    .section-title{
      margin:18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .section-title h2{
      margin:0;
      font-size:15.5px;
      font-weight:900;
      color:#111827;
    }
    .section-title .sub{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }

    /* Forms grid */
    .forms-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      align-items:stretch;
    }
    .form-card{
      grid-column: span 3;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.04);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-height:140px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .form-card:hover{
      transform: translateY(-2px);
      border-color:#d8d3ff;
      box-shadow: 0 14px 28px rgba(17,24,39,.08);
    }
    .form-card.active{
      border-color:#c4b5fd;
      box-shadow: 0 18px 34px rgba(91,46,166,.18);
    }
    .form-card .title{
      font-weight:900;
      font-size:14.5px;
      line-height:1.35;
    }
    .form-card .meta{
      color:var(--muted);
      font-size:12.5px;
      font-weight:700;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fafafa;
      color:#374151;
      width:max-content;
    }
    .dot{width:7px;height:7px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.off{background:var(--bad)}

    .card-actions{
      margin-top:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      font-size:12.5px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:7px;
    }
    .mini:hover{filter:brightness(.99)}
    .mini.primary{
      border-color:#ddd6fe;
      background:#f5f3ff;
      color:#4c1d95;
    }

    /* Create card */
    .create-card{
      background: linear-gradient(135deg, #ffffff, #faf5ff);
      border:2px dashed #d8b4fe;
    }
    .plus{
      width:48px;height:48px;border-radius:16px;
      display:grid;place-items:center;
      background:#f5f3ff;
      color:#4c1d95;
      font-size:26px;
      font-weight:900;
    }
    .create-card .title{font-size:15px}

    @media (max-width: 1100px){ .form-card{grid-column: span 4;} }
    @media (max-width: 820px){ .form-card{grid-column: span 6;} }
    @media (max-width: 560px){ .form-card{grid-column: span 12;} }

    /* Details / Stats area */
    .details{
      margin-top:16px;
      display:none;
    }
    .details.show{display:block;}
    .panel{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 6px 16px rgba(17,24,39,.04);
      overflow:hidden;
    }
    .panel-head{
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel-head .left{
      display:flex;flex-direction:column;gap:4px;
    }
    .panel-head .left .h{
      font-weight:900;
      font-size:15.5px;
    }
    .panel-head .left .s{
      color:var(--muted);
      font-weight:700;
      font-size:12.5px;
    }
    .panel-head .right{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .copy{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:9px 10px;
      font-weight:900;
      font-size:12.5px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:7px;
    }

    .stats-grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .stat{
      grid-column: span 3;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .stat .k{color:var(--muted);font-weight:800;font-size:12.5px}
    .stat .v{font-weight:900;font-size:22px}
    @media (max-width: 900px){ .stat{grid-column: span 6;} }
    @media (max-width: 520px){ .stat{grid-column: span 12;} }

    /* City cards inside details */
    .cities{
      padding:0 14px 14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .city-card{
      grid-column: span 3;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
      text-align:center;
      background:#fff;
    }
    @media (max-width: 1100px){ .city-card{grid-column: span 4;} }
    @media (max-width: 820px){ .city-card{grid-column: span 6;} }
    @media (max-width: 560px){ .city-card{grid-column: span 12;} }

    .city-name{font-weight:900;margin-bottom:10px}
    .circle{
      width:92px;height:92px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      font-weight:900;font-size:14px;color:#111827;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), #e5e7eb 0);
    }
    .city-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      font-weight:800;
    }

    /* Table */
    .table-wrap{padding:0 14px 14px;}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
    }
    thead th{
      text-align:right;
      font-size:12.5px;
      color:var(--muted);
      font-weight:900;
      background:#fafafa;
      border-bottom:1px solid var(--border);
      padding:12px 10px;
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid var(--border);
      font-weight:700;
      font-size:13.5px;
      vertical-align:middle;
      background:#fff;
    }
    tbody tr:last-child td{border-bottom:0}

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .s-pending .dot{background:var(--warn)}
    .s-confirmed .dot{background:var(--ok)}
    .s-canceled .dot{background:var(--bad)}
    .s-pending{color:#92400e}
    .s-confirmed{color:#166534}
    .s-canceled{color:#991b1b}

    .wa{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #d1fae5;
      background:#ecfdf5;
      color:#065f46;
      font-weight:900;
      text-decoration:none;
      font-size:13px;
      white-space:nowrap;
    }
    .wa svg{width:16px;height:16px}

    /* Modal */
    #modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;place-items:center;padding:18px;z-index:9999;
    }
    #modalBack.show{display:grid;}
    .modal{
      width:min(520px,100%);
      background:#fff;
      border-radius:18px;
      padding:16px;
      border:1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(0,0,0,.18);
    }
    .modal h3{margin:0 0 10px;font-weight:900}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:900}
    .field input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      font-family:inherit;
      font-weight:700;
    }
    .hint{color:#6b7280;font-size:12px;font-weight:700}
    #newFormMsg{
      display:none;
      padding:10px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fafafa;
      font-weight:900;
    }

    .toast{
      position:fixed;
      left:16px; bottom:16px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      font-size:12.5px;
      display:none;
      z-index:99999;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .toast.show{display:block;}
  </style>
</head>

<body>
  <div class="container">

    <!-- Top -->
    <div class="top">
      <div class="who">
        <div class="hello" id="hello">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</div>
        <div class="time" id="updated">Last update: â€”</div>
      </div>

      <div class="actions">
        <button class="btn white" id="btnNewForm" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬
        </button>

        <a class="btn soft" href="/" target="_blank" rel="noopener">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 3h7v7"/><path d="M10 14L21 3"/><path d="M21 14v7h-7"/><path d="M3 10V3h7"/><path d="M3 21h7"/>
          </svg>
          ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        </a>
      </div>
    </div>

    <!-- My Forms -->
    <div class="section-title">
      <h2>Ù†Ù…Ø§Ø°Ø¬ÙŠ</h2>
      <div class="sub" id="formsHint">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬â€¦</div>
    </div>

    <div class="forms-grid" id="formsGrid"></div>

    <!-- Details / stats -->
    <div class="details" id="details">
      <div class="panel">
        <div class="panel-head">
          <div class="left">
            <div class="h" id="activeFormTitle">â€”</div>
            <div class="s" id="activeFormSlug">â€”</div>
          </div>
          <div class="right">
            <a class="copy" id="openFormBtn" href="#" target="_blank" rel="noopener">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 3h7v7"/><path d="M10 14L21 3"/><path d="M21 14v7h-7"/><path d="M3 10V3h7"/><path d="M3 21h7"/>
              </svg>
              ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            </a>
            <button class="copy" id="copyLinkBtn" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat">
            <div>
              <div class="k">Total</div>
              <div class="v" id="total">â€”</div>
            </div>
          </div>
          <div class="stat">
            <div>
              <div class="k">Confirmed</div>
              <div class="v" id="confirmed">â€”</div>
            </div>
          </div>
          <div class="stat">
            <div>
              <div class="k">Pending</div>
              <div class="v" id="pending">â€”</div>
            </div>
          </div>
          <div class="stat">
            <div>
              <div class="k">Canceled</div>
              <div class="v" id="canceled">â€”</div>
            </div>
          </div>
        </div>

        <div class="section-title" style="padding:0 14px 10px;margin:0;">
          <h2 style="font-size:14.5px;">Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h2>
          <div class="sub" id="cityHint">â€”</div>
        </div>
        <div class="cities" id="citiesGrid"></div>

        <div class="section-title" style="padding:0 14px 10px;margin:0;">
          <h2 style="font-size:14.5px;">Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
          <div class="sub">Ø§Ø¶ØºØ· ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
              </tr>
            </thead>
            <tbody id="latestBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal create form -->
  <div id="modalBack">
    <div class="modal">
      <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</h3>

      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
          <input id="newFormName" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨Ø§Øª Ø±Ù…Ø¶Ø§Ù†" />
        </div>

        <div class="field">
          <label>Slug (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="newFormSlug" placeholder="ramadan-requests" />
          <div class="hint">Ù„Ùˆ ØªØ±ÙƒØªÙŠÙ‡ ÙØ§Ø¶ÙŠ Ø¨Ù†ÙˆÙ„Ø¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
        </div>

        <div id="newFormMsg"></div>

        <div style="display:flex;gap:10px;justify-content:flex-start;margin-top:6px">
          <button class="btn white" id="btnCreateForm" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
          <button class="btn soft" id="btnCloseModal" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ØªÙ…</div>

<script>
  // ---------- helpers ----------
  function num(n){ return Number(n || 0).toLocaleString("en-US"); }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
    }catch(e){
      return iso || "-";
    }
  }

  function statusBadge(status){
    const s = String(status || "").toLowerCase();
    if (s === "confirmed" || s === "received") {
      return '<span class="status s-confirmed"><span class="dot"></span>Ù…Ø¤ÙƒØ¯</span>';
    }
    if (s === "canceled" || s === "cancelled") {
      return '<span class="status s-canceled"><span class="dot"></span>Ù…Ù„ØºÙŠ</span>';
    }
    return '<span class="status s-pending"><span class="dot"></span>Ù…Ø¹Ù„Ù‚</span>';
  }

  function waLink(mobile, name, token){
    if(!mobile || !token) return "#";
    let m = String(mobile).trim();
    if(m.startsWith("05")) m = "966" + m.slice(1);
    if(m.startsWith("5") && m.length === 9) m = "966" + m;
    m = m.replace(/[^\d]/g, "");

    const confirmUrl = `${location.origin}/confirm.html?token=${token}`;
    const msg = encodeURIComponent(
`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name || ""}
ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.

Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·:
${confirmUrl}`
    );
    return `https://wa.me/${m}?text=${msg}`;
  }

  function showToast(text){
    const t = document.getElementById("toast");
    t.textContent = text;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  // ---------- auth user ----------
  async function loadUser() {
    try {
      const res = await fetch("/api/me", { credentials: "include" });
      if (!res.ok) throw new Error("unauthorized");
      const u = await res.json();
      const name =
        (u.name && u.name !== "Ù…Ø³ØªØ®Ø¯Ù…")
          ? u.name
          : (u.email ? u.email.split("@")[0] : "Ù…Ø³ØªØ®Ø¯Ù…");
      return { name, email: u.email || "" };
    } catch {
      return { name: "Ù…Ø³ØªØ®Ø¯Ù…", email: "" };
    }
  }

  // ---------- state ----------
  let FORMS = [];
  let CURRENT_FORM_ID = 0;

  function formPublicUrl(form){
    // Ø®ÙŠØ§Ø± Ø¢Ù…Ù†: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ slug
    // ØºÙŠÙ‘Ø±ÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ /f/slug Ø£Ùˆ /?form=slug
    return `${location.origin}/f/${encodeURIComponent(form.slug)}`;
  }

  // ---------- API ----------
  async function apiGetForms(){
    const res = await fetch("/api/forms", { credentials: "include" });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.ok) throw new Error(data.error || "FORMS_FAILED");
    return data.forms || [];
  }

  async function apiGetStats(formId){
    const res = await fetch(`/api/stats?form_id=${encodeURIComponent(formId)}`, { credentials: "include" });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "STATS_FAILED");
    return data;
  }

  async function apiCreateForm(payload){
    const res = await fetch("/api/forms-create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "include"
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.ok) throw new Error(data.error || "CREATE_FAILED");
    return data.form;
  }

  // ---------- UI render ----------
  function renderFormsGrid(){
    const grid = document.getElementById("formsGrid");
    const hint = document.getElementById("formsHint");

    hint.textContent = FORMS.length ? `Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: ${num(FORMS.length)}` : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø¹Ø¯. Ø£Ù†Ø´Ø¦ÙŠ Ø£ÙˆÙ„ Ù†Ù…ÙˆØ°Ø¬.";

    const createCard = `
      <div class="form-card create-card" id="createCard" role="button" aria-label="Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="plus">+</div>
          <div>
            <div class="title">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</div>
            <div class="meta">
              <div>Ø§Ø¨Ø¯Ø¦ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯ Ù…Ø«Ù„ Google Forms</div>
            </div>
          </div>
        </div>
      </div>
    `;

    const cards = FORMS.map(f => {
      const active = Number(f.id) === Number(CURRENT_FORM_ID) ? "active" : "";
      const isActive = Number(f.is_active) === 1;
      return `
        <div class="form-card ${active}" data-form-id="${f.id}">
          <div class="title">${escapeHtml(f.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</div>

          <div class="meta">
            <div>Slug: <span style="font-weight:900">${escapeHtml(f.slug || "-")}</span></div>
            <div>Created: ${f.created_at ? escapeHtml(fmtDate(f.created_at)) : "-"}</div>
            <div class="pill">
              <span class="dot ${isActive ? "ok" : "off"}"></span>
              ${isActive ? "Active" : "Inactive"}
            </div>
          </div>

          <div class="card-actions">
            <a class="mini primary" href="${formPublicUrl(f)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">
              ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            </a>
            <button class="mini" type="button" onclick="event.stopPropagation(); selectForm(${Number(f.id)})">
              Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </button>
          </div>
        </div>
      `;
    }).join("");

    grid.innerHTML = createCard + cards;

    document.getElementById("createCard").addEventListener("click", openModal);

    grid.querySelectorAll(".form-card[data-form-id]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = Number(el.getAttribute("data-form-id"));
        selectForm(id);
      });
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  async function renderStats(){
    const details = document.getElementById("details");
    const active = FORMS.find(f => Number(f.id) === Number(CURRENT_FORM_ID));
    if(!active){
      details.classList.remove("show");
      return;
    }

    // header of panel
    document.getElementById("activeFormTitle").textContent = active.name || "â€”";
    document.getElementById("activeFormSlug").textContent = `/${active.slug || "-"}`;

    const url = formPublicUrl(active);
    const openBtn = document.getElementById("openFormBtn");
    openBtn.href = url;

    document.getElementById("copyLinkBtn").onclick = async () => {
      try{
        await navigator.clipboard.writeText(url);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·");
      }catch{
        showToast("Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§");
      }
    };

    details.classList.add("show");

    // load stats
    let data;
    try{
      data = await apiGetStats(CURRENT_FORM_ID);
    }catch(e){
      showToast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª");
      return;
    }

    // numbers
    document.getElementById("total").textContent = num(data?.cards?.total ?? 0);
    document.getElementById("confirmed").textContent = num(data?.cards?.confirmed ?? 0);
    document.getElementById("pending").textContent = num(data?.cards?.pending ?? 0);
    document.getElementById("canceled").textContent = num(data?.cards?.canceled ?? 0);

    const byCity = data?.byCity || [];
    document.getElementById("cityHint").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ù†: ${num(byCity.length)}`;

    // city cards
    const citiesGrid = document.getElementById("citiesGrid");
    citiesGrid.innerHTML = byCity.map(c=>{
      const total = Number(c.total || 0);
      const confirmed = Number(c.confirmed || 0);
      const percent = total ? Math.round((confirmed / total) * 100) : 0;
      return `
        <div class="city-card">
          <div class="city-name">${escapeHtml(c.city || "-")}</div>
          <div class="circle" style="--p:${percent}">${percent}%</div>
          <div class="city-meta">
            <span>Confirmed: ${num(confirmed)}</span>
            <span>Total: ${num(total)}</span>
          </div>
        </div>
      `;
    }).join("");

    // latest table
    const latestBody = document.getElementById("latestBody");
    latestBody.innerHTML = (data?.latest || []).map(r => `
      <tr>
        <td>${escapeHtml(r.id ?? "-")}</td>
        <td>${escapeHtml(r.name || "-")}</td>
        <td>${escapeHtml(r.city || "-")}</td>
        <td>${statusBadge(r.status)}</td>
        <td>${escapeHtml(fmtDate(r.created_at))}</td>
        <td>
          ${(r.mobile && r.token) ? `
            <a class="wa" target="_blank" rel="noopener"
               href="${waLink(r.mobile, r.name, r.token)}">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.5 3.5A11 11 0 0 0 3.3 18.7L2 22l3.4-1.2A11 11 0 0 0 20.5 3.5ZM12 20a9 9 0 0 1-4.6-1.3l-.3-.2-2 .7.7-2-.2-.3A9 9 0 1 1 12 20Zm5-6.1c-.3-.1-1.7-.8-2-1s-.5-.1-.7.1-.8 1-.9 1.2-.3.2-.6.1a7.4 7.4 0 0 1-2.2-1.4 8.2 8.2 0 0 1-1.5-1.9c-.1-.3 0-.5.1-.6l.4-.5c.1-.2.2-.3.3-.5s0-.3 0-.5-.7-1.7-1-2.3c-.3-.6-.6-.5-.7-.5h-.6c-.2 0-.5.1-.7.3s-1 1-1 2.4 1 2.8 1.1 3 .3.5.5.8a11 11 0 0 0 4.2 3.8c.6.3 1.1.5 1.5.7.6.2 1.1.2 1.5.1.5-.1 1.7-.7 1.9-1.3s.2-1.1.1-1.3-.2-.1-.5-.3Z"/>
              </svg>
              ÙˆØ§ØªØ³Ø§Ø¨
            </a>
          ` : `<span style="color:#9ca3af;font-weight:900">ØºÙŠØ± Ù…ØªØ§Ø­</span>`}
        </td>
      </tr>
    `).join("");
  }

  // ---------- selection ----------
  function selectForm(id){
    CURRENT_FORM_ID = Number(id || 0);
    localStorage.setItem("current_form_id", String(CURRENT_FORM_ID));
    renderFormsGrid();
    renderStats();
    window.scrollTo({ top: document.getElementById("details").offsetTop - 10, behavior: "smooth" });
  }

  // ---------- modal ----------
  const modalBack = document.getElementById("modalBack");
  const btnNewForm = document.getElementById("btnNewForm");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnCreateForm = document.getElementById("btnCreateForm");
  const newFormName = document.getElementById("newFormName");
  const newFormSlug = document.getElementById("newFormSlug");
  const newFormMsg = document.getElementById("newFormMsg");

  function openModal(){
    modalBack.classList.add("show");
    newFormMsg.style.display = "none";
    newFormMsg.textContent = "";
    newFormName.value = "";
    newFormSlug.value = "";
    newFormName.focus();
  }
  function closeModal(){
    modalBack.classList.remove("show");
  }
  btnNewForm.addEventListener("click", openModal);
  btnCloseModal.addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

  async function createForm(){
    const payload = {
      name: newFormName.value.trim(),
      slug: newFormSlug.value.trim()
    };

    newFormMsg.style.display = "block";
    newFormMsg.style.background = "#fafafa";
    newFormMsg.style.borderColor = "#e5e7eb";
    newFormMsg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...";

    try{
      if(!payload.name){
        throw new Error("NAME_REQUIRED");
      }

      const created = await apiCreateForm(payload);

      newFormMsg.style.background = "#ecfdf5";
      newFormMsg.style.borderColor = "#bbf7d0";
      newFormMsg.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${created.name}`;

      // reload list + auto open the created one
      await initForms(created.id);

      setTimeout(()=> closeModal(), 450);
      showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬");

    }catch(err){
      let msg = String(err.message || err);
      if(msg === "SLUG_EXISTS") msg = "Ø§Ù„Ù€ slug Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ØºÙŠØ±ÙŠÙ‡.";
      if(msg === "NAME_REQUIRED") msg = "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.";
      newFormMsg.style.background = "#fef2f2";
      newFormMsg.style.borderColor = "#fecaca";
      newFormMsg.textContent = msg || "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬";
    }
  }
  btnCreateForm.addEventListener("click", createForm);

  // ---------- init ----------
  async function initForms(forceSelectId){
    FORMS = await apiGetForms();

    const saved = Number(localStorage.getItem("current_form_id") || 0);
    const first = Number(FORMS[0]?.id || 0);

    CURRENT_FORM_ID = Number(forceSelectId || saved || first || 0);

    // Ù„Ùˆ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯
    if(CURRENT_FORM_ID && !FORMS.some(f=>Number(f.id)===Number(CURRENT_FORM_ID))){
      CURRENT_FORM_ID = first;
      localStorage.setItem("current_form_id", String(CURRENT_FORM_ID));
    }

    renderFormsGrid();
    if(CURRENT_FORM_ID) await renderStats();
  }

  (async ()=>{
    const user = await loadUser();
    document.getElementById("hello").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name} ğŸ‘‹`;
    document.getElementById("updated").textContent = `Last update: ${new Date().toLocaleString("en-US")}`;

    try{
      await initForms();
    }catch(e){
      document.getElementById("formsHint").textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (ØªØ­Ù‚Ù‚ÙŠ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Cloudflare Access Ù„Ù…Ø³Ø§Ø± /api/*).";
      showToast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬");
    }
  })();
</script>

</body>
</html>
